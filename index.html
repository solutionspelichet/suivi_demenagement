<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suivi Déménagement</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="[https://img.icons8.com/fluency/96/home.png](https://img.icons8.com/fluency/96/home.png)">
    
    <!-- Tailwind CSS pour le style rapide -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <!-- FontAwesome pour les icônes -->
    <link rel="stylesheet" href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css)">

    <style>
        /* Styles spécifiques pour l'expérience mobile */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-md">
        <h1 class="text-xl font-bold flex items-center">
            <i class="fa-solid fa-box-open mr-2"></i> État des Lieux
        </h1>
    </header>

    <!-- Contenu Principal -->
    <main class="p-4 max-w-md mx-auto">
        
        <!-- Formulaire -->
        <form id="inspectionForm" class="space-y-4">
            
            <!-- Sélection Appartement -->
            <div class="bg-white p-4 rounded-lg shadow">
                <label class="block text-gray-700 text-sm font-bold mb-2">Appartement</label>
                <div class="relative">
                    <select id="appartement" class="block appearance-none w-full bg-gray-50 border border-gray-300 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-blue-500">
                        <option value="Appartement A">Appartement A (Centre)</option>
                        <option value="Appartement B">Appartement B (Sud)</option>
                        <option value="Nouveau">Autre / Nouveau...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
                <input type="text" id="newAppart" placeholder="Nom du nouvel appart" class="mt-2 w-full p-2 border rounded hidden">
            </div>

            <!-- Sélection Pièce -->
            <div class="bg-white p-4 rounded-lg shadow">
                <label class="block text-gray-700 text-sm font-bold mb-2">Pièce</label>
                <div class="flex flex-wrap gap-2" id="roomTags">
                    <!-- Généré par JS -->
                </div>
                <input type="hidden" id="selectedRoom" value="">
                <input type="text" id="customRoom" placeholder="Nom de la pièce..." class="mt-3 w-full p-2 border rounded text-sm hidden">
            </div>

            <!-- Photo & Géoloc -->
            <div class="bg-white p-4 rounded-lg shadow text-center">
                
                <!-- Prévisualisation -->
                <div id="previewContainer" class="hidden mb-4 relative">
                    <img id="photoPreview" class="w-full h-48 object-cover rounded-lg border-2 border-blue-100">
                    <button type="button" id="clearPhoto" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full w-8 h-8 flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>

                <!-- Bouton Caméra -->
                <label for="cameraInput" class="cursor-pointer bg-blue-50 hover:bg-blue-100 text-blue-600 font-semibold py-4 px-4 rounded-lg border-2 border-blue-500 border-dashed w-full flex flex-col items-center justify-center transition">
                    <i class="fa-solid fa-camera text-3xl mb-2"></i>
                    <span id="cameraText">Prendre une photo</span>
                </label>
                <!-- capture="environment" force la caméra arrière sur mobile -->
                <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
                
                <!-- Info GPS -->
                <div id="gpsStatus" class="mt-3 text-xs text-gray-500 flex items-center justify-center">
                    <i class="fa-solid fa-location-dot mr-1"></i> <span id="gpsText">En attente de localisation...</span>
                </div>
            </div>

            <!-- Notes -->
            <div class="bg-white p-4 rounded-lg shadow">
                <label class="block text-gray-700 text-sm font-bold mb-2">Notes / Observations</label>
                <textarea id="notes" rows="3" class="w-full p-2 border border-gray-300 rounded focus:border-blue-500 outline-none" placeholder="Ex: Rayure sur le parquet..."></textarea>
            </div>

            <!-- Bouton Envoyer -->
            <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-lg shadow-lg text-lg flex justify-center items-center transition disabled:opacity-50 disabled:cursor-not-allowed">
                <span>Enregistrer</span>
                <i class="fa-solid fa-paper-plane ml-2"></i>
            </button>

        </form>

        <!-- Notification Toast -->
        <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50">
            Message envoyé
        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        // TODO: COLLE ICI L'URL DE TON DÉPLOIEMENT APPS SCRIPT
        const API_URL = "TA_URL_WEB_APP_ICI"; 

        // --- ÉTAT ---
        let currentImageBase64 = null;
        let currentLat = "";
        let currentLon = "";

        // --- DOM ELEMENTS ---
        const els = {
            form: document.getElementById('inspectionForm'),
            cameraInput: document.getElementById('cameraInput'),
            previewContainer: document.getElementById('previewContainer'),
            photoPreview: document.getElementById('photoPreview'),
            clearPhoto: document.getElementById('clearPhoto'),
            cameraText: document.getElementById('cameraText'),
            gpsText: document.getElementById('gpsText'),
            submitBtn: document.getElementById('submitBtn'),
            appartement: document.getElementById('appartement'),
            newAppart: document.getElementById('newAppart'),
            roomTags: document.getElementById('roomTags'),
            selectedRoomInput: document.getElementById('selectedRoom'),
            customRoom: document.getElementById('customRoom'),
            notes: document.getElementById('notes'),
            toast: document.getElementById('toast')
        };

        // --- INITIALISATION ---
        const rooms = ["Entrée", "Salon", "Cuisine", "Chambre 1", "Chambre 2", "SDB", "WC", "Autre"];
        
        // Génération des tags de pièces
        rooms.forEach(room => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `px-3 py-1 rounded-full text-sm border transition ${room === 'Salon' ? 'bg-blue-500 text-white border-blue-500' : 'bg-gray-100 text-gray-600 border-gray-200'}`;
            btn.innerText = room;
            btn.onclick = () => selectRoom(room, btn);
            els.roomTags.appendChild(btn);
            if(room === 'Salon') selectRoom('Salon', btn);
        });

        function selectRoom(roomName, btnElement) {
            // Reset styles
            Array.from(els.roomTags.children).forEach(b => {
                b.className = 'px-3 py-1 rounded-full text-sm border bg-gray-100 text-gray-600 border-gray-200';
            });
            // Set Active
            btnElement.className = 'px-3 py-1 rounded-full text-sm border bg-blue-500 text-white border-blue-500 shadow';
            els.selectedRoomInput.value = roomName;
            
            // Afficher input si "Autre"
            if(roomName === 'Autre') {
                els.customRoom.classList.remove('hidden');
                els.customRoom.focus();
            } else {
                els.customRoom.classList.add('hidden');
            }
        }

        // Gestion Appartement "Nouveau"
        els.appartement.addEventListener('change', (e) => {
            if(e.target.value === 'Nouveau') {
                els.newAppart.classList.remove('hidden');
                els.newAppart.focus();
            } else {
                els.newAppart.classList.add('hidden');
            }
        });

        // --- GÉOLOCALISATION ---
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLon = position.coords.longitude;
                    els.gpsText.innerText = `GPS: ${currentLat.toFixed(4)}, ${currentLon.toFixed(4)}`;
                    els.gpsText.className = "text-green-600 font-bold";
                },
                (error) => {
                    console.error("Erreur GPS", error);
                    els.gpsText.innerText = "GPS non disponible";
                    els.gpsText.className = "text-red-500";
                },
                { enableHighAccuracy: true }
            );
        }

        // --- GESTION PHOTO (Conversion Base64 + Compression basique) ---
        els.cameraInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                // Afficher le loader ou texte
                els.cameraText.innerText = "Traitement...";
                
                const reader = new FileReader();
                reader.onloadend = function() {
                    // Compression simple via Canvas (pour ne pas dépasser les limites GAS)
                    const img = new Image();
                    img.src = reader.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Redimensionner (Max 1200px de large)
                        const maxWidth = 1200;
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Récupérer le base64 compressé (JPEG 0.7 quality)
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        currentImageBase64 = compressedDataUrl.split(',')[1]; // Enlever le préfixe "data:image/jpeg;base64,"
                        
                        // Afficher preview
                        els.photoPreview.src = compressedDataUrl;
                        els.previewContainer.classList.remove('hidden');
                        els.cameraText.innerText = "Changer la photo";
                    }
                }
                reader.readAsDataURL(file);
            }
        });

        els.clearPhoto.addEventListener('click', () => {
            currentImageBase64 = null;
            els.cameraInput.value = "";
            els.previewContainer.classList.add('hidden');
            els.cameraText.innerText = "Prendre une photo";
        });

        // --- SOUMISSION DU FORMULAIRE ---
        els.form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentImageBase64) {
                showToast("Veuillez prendre une photo !", true);
                return;
            }

            setLoading(true);

            // Préparation des données
            const appName = els.appartement.value === 'Nouveau' ? els.newAppart.value : els.appartement.value;
            const roomName = els.selectedRoomInput.value === 'Autre' ? els.customRoom.value : els.selectedRoomInput.value;

            const payload = {
                appartement: appName,
                piece: roomName,
                note: els.notes.value,
                lat: currentLat,
                lon: currentLon,
                image: currentImageBase64
            };

            try {
                // Envoi vers Apps Script
                // Note: mode 'no-cors' ne permet pas de lire la réponse JSON, mais 'cors' requiert que le serveur renvoie les bons headers (ce qu'on a fait)
                // Google Apps Script redirect, donc on doit gérer ça.
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    showToast("Photo sauvegardée avec succès !");
                    resetForm();
                } else {
                    showToast("Erreur serveur: " + result.message, true);
                }

            } catch (err) {
                console.error(err);
                showToast("Erreur réseau ou script.", true);
            } finally {
                setLoading(false);
            }
        });

        // --- UTILITAIRES ---
        function setLoading(isLoading) {
            els.submitBtn.disabled = isLoading;
            if (isLoading) {
                els.submitBtn.innerHTML = '<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6"></div>';
            } else {
                els.submitBtn.innerHTML = '<span>Enregistrer</span><i class="fa-solid fa-paper-plane ml-2"></i>';
            }
        }

        function resetForm() {
            els.notes.value = "";
            els.clearPhoto.click(); // Reset photo
        }

        function showToast(message, isError = false) {
            els.toast.innerText = message;
            els.toast.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg opacity-100 transition-opacity duration-300 pointer-events-none z-50 ${isError ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
            
            setTimeout(() => {
                els.toast.classList.remove('opacity-100');
                els.toast.classList.add('opacity-0');
            }, 3000);
        }

        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW enregistré', reg))
                    .catch(err => console.log('SW échec', err));
            });
        }
    </script>
</body>
</html>
